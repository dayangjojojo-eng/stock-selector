<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºé€‰è‚¡ Ultimate - ä¸“ä¸šçº§è‚¡ç¥¨ç­›é€‰ä¸åˆ†æå¹³å°</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: #f5f7fa;
            color: #333;
        }
        .container { max-width: 1800px; margin: 0 auto; }
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        header h1 { font-size: 2em; margin-bottom: 5px; }
        .subtitle { font-size: 0.95em; opacity: 0.9; }
        .main-layout {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
            padding: 20px;
        }
        .sidebar {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            height: fit-content;
            position: sticky;
            top: 20px;
        }
        .sidebar h2 { font-size: 1.1em; margin-bottom: 15px; color: #333; border-bottom: 2px solid #667eea; padding-bottom: 10px; }
        .filter-group { margin-bottom: 12px; }
        .filter-group label { display: block; font-weight: 600; margin-bottom: 5px; font-size: 0.85em; color: #555; }
        .filter-group input, .filter-group select { width: 100%; padding: 7px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.85em; }
        .filter-group input:focus, .filter-group select:focus { outline: none; border-color: #667eea; }
        .range-inputs { display: flex; gap: 5px; align-items: center; }
        .range-inputs input { flex: 1; }
        .range-inputs span { color: #999; font-size: 0.85em; }
        .btn { width: 100%; padding: 10px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: all 0.3s; margin-bottom: 8px; font-size: 0.9em; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102,126,234,0.4); }
        .btn-secondary { background: #f0f0f0; color: #333; }
        .btn-secondary:hover { background: #e0e0e0; }
        .btn-success { background: #27ae60; color: white; }
        .content { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .tabs { display: flex; gap: 8px; margin-bottom: 20px; border-bottom: 2px solid #f0f0f0; flex-wrap: wrap; }
        .tab-btn { padding: 10px 16px; background: none; border: none; cursor: pointer; font-weight: 600; color: #999; border-bottom: 3px solid transparent; transition: all 0.3s; font-size: 0.9em; }
        .tab-btn.active { color: #667eea; border-bottom-color: #667eea; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 20px; }
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 8px; text-align: center; }
        .stat-label { font-size: 0.85em; opacity: 0.9; margin-bottom: 5px; }
        .stat-value { font-size: 1.5em; font-weight: 600; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9em; }
        thead { background: #f8f9fa; }
        th { padding: 10px; text-align: left; font-weight: 600; color: #333; border-bottom: 2px solid #e0e0e0; cursor: pointer; }
        th:hover { background: #f0f0f0; }
        td { padding: 10px; border-bottom: 1px solid #f0f0f0; }
        tbody tr:hover { background: #f8f9fa; }
        .code { font-weight: 600; color: #667eea; }
        .change { font-weight: 600; padding: 3px 6px; border-radius: 4px; }
        .change.up { color: #f56c6c; background: #ffe0e0; }
        .change.down { color: #67c23a; background: #e0ffe0; }
        .btn-small { padding: 5px 10px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8em; margin-right: 3px; }
        .btn-small:hover { background: #764ba2; }
        .chart-container { background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 10px 0; min-height: 350px; }
        .chart-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .indicator-panel { background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 10px 0; }
        .indicator-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; }
        .indicator-item { background: white; padding: 12px; border-radius: 6px; text-align: center; border-left: 3px solid #667eea; }
        .indicator-label { font-size: 0.8em; color: #666; margin-bottom: 5px; }
        .indicator-value { font-size: 1.2em; font-weight: 600; }
        .indicator-value.bullish { color: #f56c6c; }
        .indicator-value.bearish { color: #67c23a; }
        .indicator-value.neutral { color: #999; }
        .comparison-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .comparison-card { background: #f8f9fa; padding: 20px; border-radius: 8px; }
        .comparison-card h4 { margin-bottom: 15px; color: #333; border-bottom: 2px solid #667eea; padding-bottom: 8px; }
        .comparison-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; }
        .flow-chart { min-height: 300px; }
        .input-row { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .input-row input, .input-row select { flex: 1; min-width: 120px; padding: 8px; border: 1px solid #ddd; border-radius: 6px; }
        .loading { text-align: center; padding: 20px; color: #999; }
        .message { padding: 10px; border-radius: 6px; margin-bottom: 10px; }
        .message.success { background: #e0ffe0; color: #27ae60; }
        .message.error { background: #ffe0e0; color: #f56c6c; }
        .message.info { background: #e0f0ff; color: #3498db; }
        @media (max-width: 1200px) { .chart-row { grid-template-columns: 1fr; } .comparison-container { grid-template-columns: 1fr; } }
        @media (max-width: 768px) { .main-layout { grid-template-columns: 1fr; } .sidebar { position: static; } }
    </style>
</head>
<body>
    <header>
        <h1>ğŸ“ˆ æ™ºé€‰è‚¡ Ultimate</h1>
        <p class="subtitle">ä¸“ä¸šçº§è‚¡ç¥¨ç­›é€‰ä¸åˆ†æå¹³å° - ç»ˆæç‰ˆ | å®æ—¶æ•°æ® + æŠ€æœ¯åˆ†æ + èµ„é‡‘æµå‘</p>
    </header>

    <div class="container">
        <div class="main-layout">
            <!-- ä¾§è¾¹æ  -->
            <div class="sidebar">
                <h2>ğŸ” æœç´¢è‚¡ç¥¨</h2>
                <div class="filter-group">
                    <label>è¾“å…¥è‚¡ç¥¨ä»£ç æœç´¢</label>
                    <div class="range-inputs">
                        <input type="text" id="searchCode" placeholder="å¦‚: 600519">
                        <button class="btn-small" onclick="searchStock()" style="width:60px;">æœç´¢</button>
                    </div>
                </div>
                <hr style="margin: 15px 0; border: none; border-top: 1px solid #eee;">
                <h2>ğŸ” ç­›é€‰æ¡ä»¶</h2>
                <div class="filter-group">
                    <label>è‚¡ç¥¨ä»£ç /åç§°</label>
                    <input type="text" id="codeFilter" placeholder="åœ¨åˆ—è¡¨ä¸­ç­›é€‰">
                </div>
                <div class="filter-group">
                    <label>ä»·æ ¼èŒƒå›´ (Â¥)</label>
                    <div class="range-inputs">
                        <input type="number" id="priceMin" placeholder="æœ€ä½" min="0">
                        <span>-</span>
                        <input type="number" id="priceMax" placeholder="æœ€é«˜" min="0">
                    </div>
                </div>
                <div class="filter-group">
                    <label>æ¶¨è·Œå¹… (%)</label>
                    <div class="range-inputs">
                        <input type="number" id="changeMin" placeholder="æœ€ä½" step="0.1">
                        <span>-</span>
                        <input type="number" id="changeMax" placeholder="æœ€é«˜" step="0.1">
                    </div>
                </div>
                <div class="filter-group">
                    <label>å¸‚ç›ˆç‡ (PE)</label>
                    <div class="range-inputs">
                        <input type="number" id="peMin" placeholder="æœ€ä½" min="0">
                        <span>-</span>
                        <input type="number" id="peMax" placeholder="æœ€é«˜" min="0">
                    </div>
                </div>
                <div class="filter-group">
                    <label>å¸‚å‡€ç‡ (PB)</label>
                    <div class="range-inputs">
                        <input type="number" id="pbMin" placeholder="æœ€ä½" min="0" step="0.1">
                        <span>-</span>
                        <input type="number" id="pbMax" placeholder="æœ€é«˜" min="0" step="0.1">
                    </div>
                </div>
                <div class="filter-group">
                    <label>ROE (%)</label>
                    <div class="range-inputs">
                        <input type="number" id="roeMin" placeholder="æœ€ä½" step="0.1">
                        <span>-</span>
                        <input type="number" id="roeMax" placeholder="æœ€é«˜" step="0.1">
                    </div>
                </div>
                <div class="filter-group">
                    <label>è¡Œä¸šåˆ†ç±»</label>
                    <select id="industryFilter">
                        <option value="">å…¨éƒ¨è¡Œä¸š</option>
                        <option value="tech">ç§‘æŠ€</option>
                        <option value="finance">é‡‘è</option>
                        <option value="healthcare">åŒ»ç–—</option>
                        <option value="energy">èƒ½æº</option>
                        <option value="consumer">æ¶ˆè´¹</option>
                        <option value="material">ææ–™</option>
                        <option value="industrial">å·¥ä¸š</option>
                    </select>
                </div>
                <button class="btn btn-primary" id="filterBtn">ğŸ” åº”ç”¨ç­›é€‰</button>
                <button class="btn btn-secondary" id="resetBtn">â†º é‡ç½®æ¡ä»¶</button>
                <button class="btn btn-success" id="refreshBtn">ğŸ”„ åˆ·æ–°æ•°æ®</button>
            </div>

            <!-- ä¸»å†…å®¹åŒº -->
            <div class="content">
                <div class="tabs">
                    <button class="tab-btn active" onclick="switchTab('overview')">ğŸ“Š æ¦‚è§ˆ</button>
                    <button class="tab-btn" onclick="switchTab('stocks')">ğŸ“ˆ è‚¡ç¥¨åˆ—è¡¨</button>
                    <button class="tab-btn" onclick="switchTab('technical')">ğŸ“‰ æŠ€æœ¯åˆ†æ</button>
                    <button class="tab-btn" onclick="switchTab('indicators')">ğŸ“ æŠ€æœ¯æŒ‡æ ‡</button>
                    <button class="tab-btn" onclick="switchTab('flow')">ğŸ’° èµ„é‡‘æµå‘</button>
                    <button class="tab-btn" onclick="switchTab('comparison')">âš–ï¸ å¯¹æ¯”åˆ†æ</button>
                    <button class="tab-btn" onclick="switchTab('portfolio')">ğŸ’¼ æŠ•èµ„ç»„åˆ</button>
                    <button class="tab-btn" onclick="switchTab('favorites')">â­ æ”¶è—</button>
                </div>

                <!-- æ¦‚è§ˆ -->
                <div id="tab-overview" class="tab-content active">
                    <h2>ğŸ“Š å¸‚åœºæ¦‚è§ˆ</h2>
                    <div id="overviewMsg"></div>
                    <div class="stats-grid">
                        <div class="stat-card"><div class="stat-label">è‚¡ç¥¨æ€»æ•°</div><div class="stat-value" id="statTotal">0</div></div>
                        <div class="stat-card"><div class="stat-label">å¹³å‡ä»·æ ¼</div><div class="stat-value" id="statAvgPrice">Â¥0</div></div>
                        <div class="stat-card"><div class="stat-label">å¹³å‡æ¶¨å¹…</div><div class="stat-value" id="statAvgChange">0%</div></div>
                        <div class="stat-card"><div class="stat-label">ä¸Šæ¶¨è‚¡ç¥¨</div><div class="stat-value" id="statUp">0</div></div>
                        <div class="stat-card"><div class="stat-label">ä¸‹è·Œè‚¡ç¥¨</div><div class="stat-value" id="statDown">0</div></div>
                        <div class="stat-card"><div class="stat-label">å¹³å‡PE</div><div class="stat-value" id="statAvgPe">0</div></div>
                    </div>
                    <div class="chart-container" id="industryChart" style="min-height: 300px;"></div>
                </div>

                <!-- è‚¡ç¥¨åˆ—è¡¨ -->
                <div id="tab-stocks" class="tab-content">
                    <h2>ğŸ“ˆ è‚¡ç¥¨åˆ—è¡¨ <span id="stockCount" style="font-size: 0.7em; color: #999;"></span></h2>
                    <div style="margin-bottom: 10px;">
                        <button class="btn-small" onclick="exportData()">ğŸ“¥ å¯¼å‡ºCSV</button>
                    </div>
                    <table id="stockTable">
                        <thead>
                            <tr>
                                <th onclick="sortTable('code')">ä»£ç </th>
                                <th onclick="sortTable('name')">åç§°</th>
                                <th onclick="sortTable('price')">ç°ä»·</th>
                                <th onclick="sortTable('change')">æ¶¨è·Œå¹…</th>
                                <th onclick="sortTable('pe')">PE</th>
                                <th onclick="sortTable('pb')">PB</th>
                                <th onclick="sortTable('roe')">ROE</th>
                                <th>è¡Œä¸š</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>

                <!-- æŠ€æœ¯åˆ†æ -->
                <div id="tab-technical" class="tab-content">
                    <h2>ğŸ“‰ æŠ€æœ¯åˆ†æ</h2>
                    <div class="input-row">
                        <input type="text" id="techCode" placeholder="è¾“å…¥è‚¡ç¥¨ä»£ç  (å¦‚: 600000)">
                        <button class="btn-small" onclick="loadTechnicalAnalysis()">åˆ†æ</button>
                    </div>
                    <div id="techMsg"></div>
                    <div class="chart-row">
                        <div class="chart-container" id="klineChart"></div>
                        <div class="chart-container" id="volumeChart"></div>
                    </div>
                    <div class="chart-row">
                        <div class="chart-container" id="maChart"></div>
                        <div class="chart-container" id="macdChart"></div>
                    </div>
                </div>

                <!-- æŠ€æœ¯æŒ‡æ ‡ -->
                <div id="tab-indicators" class="tab-content">
                    <h2>ğŸ“ æŠ€æœ¯æŒ‡æ ‡</h2>
                    <div class="input-row">
                        <input type="text" id="indicatorCode" placeholder="è¾“å…¥è‚¡ç¥¨ä»£ç ">
                        <button class="btn-small" onclick="loadIndicators()">è®¡ç®—æŒ‡æ ‡</button>
                    </div>
                    <div id="indicatorMsg"></div>
                    <div class="indicator-panel">
                        <h3 style="margin-bottom: 15px;">ğŸ“Š ç»¼åˆæŒ‡æ ‡</h3>
                        <div class="indicator-grid" id="indicatorGrid"></div>
                    </div>
                    <div class="chart-row">
                        <div class="chart-container" id="rsiChart"></div>
                        <div class="chart-container" id="kdjChart"></div>
                    </div>
                    <div class="chart-container" id="bollingerChart"></div>
                </div>

                <!-- èµ„é‡‘æµå‘ -->
                <div id="tab-flow" class="tab-content">
                    <h2>ğŸ’° èµ„é‡‘æµå‘</h2>
                    <div class="input-row">
                        <input type="text" id="flowCode" placeholder="è¾“å…¥è‚¡ç¥¨ä»£ç ">
                        <button class="btn-small" onclick="loadFlowAnalysis()">åˆ†æèµ„é‡‘</button>
                    </div>
                    <div id="flowMsg"></div>
                    <div class="stats-grid">
                        <div class="stat-card" style="background: #f56c6c;"><div class="stat-label">ä¸»åŠ›å‡€æµå…¥</div><div class="stat-value" id="mainFlow">Â¥0</div></div>
                        <div class="stat-card" style="background: #e6a23c;"><div class="stat-label">å¤§å•å‡€æµå…¥</div><div class="stat-value" id="bigFlow">Â¥0</div></div>
                        <div class="stat-card" style="background: #409eff;"><div class="stat-label">ä¸­å•å‡€æµå…¥</div><div class="stat-value" id="midFlow">Â¥0</div></div>
                        <div class="stat-card" style="background: #67c23a;"><div class="stat-label">å°å•å‡€æµå…¥</div><div class="stat-value" id="smallFlow">Â¥0</div></div>
                    </div>
                    <div class="chart-row">
                        <div class="chart-container flow-chart" id="flowPieChart"></div>
                        <div class="chart-container flow-chart" id="flowBarChart"></div>
                    </div>
                    <div class="chart-container" id="flowTrendChart"></div>
                </div>

                <!-- å¯¹æ¯”åˆ†æ -->
                <div id="tab-comparison" class="tab-content">
                    <h2>âš–ï¸ å¯¹æ¯”åˆ†æ</h2>
                    <div class="input-row">
                        <input type="text" id="compareCode1" placeholder="è‚¡ç¥¨1ä»£ç ">
                        <input type="text" id="compareCode2" placeholder="è‚¡ç¥¨2ä»£ç ">
                        <button class="btn-small" onclick="compareStocks()">å¯¹æ¯”</button>
                    </div>
                    <div id="compareMsg"></div>
                    <div class="comparison-container" id="comparisonResult"></div>
                    <div class="chart-container" id="compareChart"></div>
                </div>

                <!-- æŠ•èµ„ç»„åˆ -->
                <div id="tab-portfolio" class="tab-content">
                    <h2>ğŸ’¼ æŠ•èµ„ç»„åˆ</h2>
                    <div class="input-row">
                        <input type="text" id="portfolioCode" placeholder="è‚¡ç¥¨ä»£ç ">
                        <input type="number" id="portfolioQty" placeholder="æ•°é‡">
                        <input type="number" id="portfolioCost" placeholder="æˆæœ¬ä»·">
                        <button class="btn-small" onclick="addPortfolio()">æ·»åŠ </button>
                    </div>
                    <table>
                        <thead><tr><th>ä»£ç </th><th>åç§°</th><th>æ•°é‡</th><th>æˆæœ¬</th><th>ç°ä»·</th><th>æ”¶ç›Š</th><th>æ”¶ç›Šç‡</th><th>æ“ä½œ</th></tr></thead>
                        <tbody id="portfolioBody"></tbody>
                    </table>
                    <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <p><strong>æ€»å¸‚å€¼:</strong> <span id="portfolioTotal">Â¥0</span> | <strong>æ€»æˆæœ¬:</strong> <span id="portfolioCostTotal">Â¥0</span> | <strong>æ€»æ”¶ç›Š:</strong> <span id="portfolioProfit">Â¥0</span> (<span id="portfolioRate">0%</span>)</p>
                    </div>
                </div>

                <!-- æ”¶è— -->
                <div id="tab-favorites" class="tab-content">
                    <h2>â­ æˆ‘çš„æ”¶è—</h2>
                    <table>
                        <thead><tr><th>ä»£ç </th><th>åç§°</th><th>ç°ä»·</th><th>æ¶¨è·Œå¹…</th><th>PE</th><th>è¡Œä¸š</th><th>æ“ä½œ</th></tr></thead>
                        <tbody id="favoritesBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== æ•°æ®é…ç½® ====================
        const industryMap = { 'tech': 'ç§‘æŠ€', 'finance': 'é‡‘è', 'healthcare': 'åŒ»ç–—', 'energy': 'èƒ½æº', 'consumer': 'æ¶ˆè´¹', 'material': 'ææ–™', 'industrial': 'å·¥ä¸š' };
        
        // è‚¡ç¥¨åŸºç¡€ä¿¡æ¯ï¼ˆPEã€PBã€ROEã€è¡Œä¸šç­‰é™æ€æ•°æ®ï¼‰
        const stockInfo = {
            'sh600000': { name: 'æµ¦å‘é“¶è¡Œ', pe: 6.8, pb: 0.65, roe: 9.5, industry: 'finance' },
            'sz000858': { name: 'äº”ç²®æ¶²', pe: 28.5, pb: 8.2, roe: 28.8, industry: 'consumer' },
            'sh600519': { name: 'è´µå·èŒ…å°', pe: 32.1, pb: 15.8, roe: 49.2, industry: 'consumer' },
            'sz000333': { name: 'ç¾çš„é›†å›¢', pe: 15.2, pb: 3.5, roe: 23.1, industry: 'consumer' },
            'sh600036': { name: 'æ‹›å•†é“¶è¡Œ', pe: 7.5, pb: 0.95, roe: 12.6, industry: 'finance' },
            'sz000651': { name: 'æ ¼åŠ›ç”µå™¨', pe: 12.3, pb: 2.8, roe: 22.8, industry: 'consumer' },
            'sh601398': { name: 'å·¥å•†é“¶è¡Œ', pe: 5.9, pb: 0.58, roe: 9.8, industry: 'finance' },
            'sz300750': { name: 'å®å¾·æ—¶ä»£', pe: 45.6, pb: 8.2, roe: 18.2, industry: 'tech' },
            'sh600900': { name: 'é•¿æ±Ÿç”µåŠ›', pe: 11.2, pb: 1.2, roe: 10.8, industry: 'energy' },
            'sh601988': { name: 'ä¸­å›½é“¶è¡Œ', pe: 5.2, pb: 0.48, roe: 9.2, industry: 'finance' },
            'sh600588': { name: 'ç”¨å‹ç½‘ç»œ', pe: 38.9, pb: 5.2, roe: 13.4, industry: 'tech' },
            'sz000001': { name: 'å¹³å®‰é“¶è¡Œ', pe: 5.8, pb: 0.62, roe: 10.5, industry: 'finance' },
            'sh600276': { name: 'æ’ç‘åŒ»è¯', pe: 52.3, pb: 6.8, roe: 13.2, industry: 'healthcare' },
            'sz000002': { name: 'ä¸‡ç§‘A', pe: 8.5, pb: 0.85, roe: 10.2, industry: 'industrial' },
            'sh601318': { name: 'ä¸­å›½å¹³å®‰', pe: 8.2, pb: 1.1, roe: 13.5, industry: 'finance' },
            'sz002415': { name: 'æµ·åº·å¨è§†', pe: 22.5, pb: 4.5, roe: 20.1, industry: 'tech' },
            'sh600887': { name: 'ä¼Šåˆ©è‚¡ä»½', pe: 18.5, pb: 4.2, roe: 22.8, industry: 'consumer' },
            'sz000568': { name: 'æ³¸å·è€çª–', pe: 25.6, pb: 7.5, roe: 29.3, industry: 'consumer' },
            'sh601012': { name: 'éš†åŸºç»¿èƒ½', pe: 15.8, pb: 2.8, roe: 17.8, industry: 'energy' },
            'sz002594': { name: 'æ¯”äºšè¿ª', pe: 35.2, pb: 5.8, roe: 16.5, industry: 'tech' },
            'sh600309': { name: 'ä¸‡ååŒ–å­¦', pe: 12.8, pb: 3.2, roe: 25.1, industry: 'material' },
            'sz002304': { name: 'æ´‹æ²³è‚¡ä»½', pe: 22.3, pb: 5.5, roe: 24.6, industry: 'consumer' },
            'sh601899': { name: 'ç´«é‡‘çŸ¿ä¸š', pe: 15.2, pb: 3.8, roe: 25.2, industry: 'material' },
            'sh600031': { name: 'ä¸‰ä¸€é‡å·¥', pe: 10.5, pb: 1.8, roe: 17.2, industry: 'industrial' },
            'sz002475': { name: 'ç«‹è®¯ç²¾å¯†', pe: 28.5, pb: 5.2, roe: 18.3, industry: 'tech' },
            'sh600030': { name: 'ä¸­ä¿¡è¯åˆ¸', pe: 18.5, pb: 1.5, roe: 8.2, industry: 'finance' },
            'sz000725': { name: 'äº¬ä¸œæ–¹A', pe: 25.8, pb: 1.2, roe: 4.8, industry: 'tech' },
            'sh601166': { name: 'å…´ä¸šé“¶è¡Œ', pe: 5.5, pb: 0.55, roe: 10.1, industry: 'finance' },
            'sz000063': { name: 'ä¸­å…´é€šè®¯', pe: 22.5, pb: 2.8, roe: 12.5, industry: 'tech' },
            'sz002352': { name: 'é¡ºä¸°æ§è‚¡', pe: 32.5, pb: 3.5, roe: 10.8, industry: 'industrial' }
        };

        // è‚¡ç¥¨ä»£ç åˆ—è¡¨ï¼ˆç”¨äºAPIè¯·æ±‚ï¼‰
        const stockCodes = Object.keys(stockInfo);

        // å¤‡ç”¨æœ¬åœ°æ•°æ®
        const stockDatabase = [
            { code: '600000', name: 'æµ¦å‘é“¶è¡Œ', price: 8.45, change: 2.3, pe: 6.8, pb: 0.65, roe: 9.5, industry: 'finance' },
            { code: '000858', name: 'äº”ç²®æ¶²', price: 142.50, change: -1.2, pe: 28.5, pb: 8.2, roe: 28.8, industry: 'consumer' },
            { code: '600519', name: 'è´µå·èŒ…å°', price: 1856.00, change: 3.5, pe: 32.1, pb: 15.8, roe: 49.2, industry: 'consumer' },
            { code: '000333', name: 'ç¾çš„é›†å›¢', price: 32.80, change: 1.8, pe: 15.2, pb: 3.5, roe: 23.1, industry: 'consumer' },
            { code: '600036', name: 'æ‹›å•†é“¶è¡Œ', price: 28.95, change: 0.5, pe: 7.5, pb: 0.95, roe: 12.6, industry: 'finance' },
            { code: '000651', name: 'æ ¼åŠ›ç”µå™¨', price: 28.50, change: -0.8, pe: 12.3, pb: 2.8, roe: 22.8, industry: 'consumer' },
            { code: '601398', name: 'å·¥å•†é“¶è¡Œ', price: 5.28, change: 1.2, pe: 5.9, pb: 0.58, roe: 9.8, industry: 'finance' },
            { code: '300750', name: 'å®å¾·æ—¶ä»£', price: 185.30, change: 4.2, pe: 45.6, pb: 8.2, roe: 18.2, industry: 'tech' },
            { code: '600900', name: 'é•¿æ±Ÿç”µåŠ›', price: 18.65, change: 0.3, pe: 11.2, pb: 1.2, roe: 10.8, industry: 'energy' },
            { code: '601988', name: 'ä¸­å›½é“¶è¡Œ', price: 3.15, change: 0.8, pe: 5.2, pb: 0.48, roe: 9.2, industry: 'finance' },
            { code: '600588', name: 'ç”¨å‹ç½‘ç»œ', price: 32.10, change: 2.1, pe: 38.9, pb: 5.2, roe: 13.4, industry: 'tech' },
            { code: '000001', name: 'å¹³å®‰é“¶è¡Œ', price: 10.25, change: 1.5, pe: 5.8, pb: 0.62, roe: 10.5, industry: 'finance' },
            { code: '600276', name: 'æ’ç‘åŒ»è¯', price: 45.80, change: -2.1, pe: 52.3, pb: 6.8, roe: 13.2, industry: 'healthcare' },
            { code: '000002', name: 'ä¸‡ç§‘A', price: 12.35, change: -1.8, pe: 8.5, pb: 0.85, roe: 10.2, industry: 'industrial' },
            { code: '601318', name: 'ä¸­å›½å¹³å®‰', price: 42.50, change: 0.9, pe: 8.2, pb: 1.1, roe: 13.5, industry: 'finance' },
            { code: '002415', name: 'æµ·åº·å¨è§†', price: 35.20, change: 3.2, pe: 22.5, pb: 4.5, roe: 20.1, industry: 'tech' },
            { code: '600887', name: 'ä¼Šåˆ©è‚¡ä»½', price: 28.90, change: 1.1, pe: 18.5, pb: 4.2, roe: 22.8, industry: 'consumer' },
            { code: '000568', name: 'æ³¸å·è€çª–', price: 168.50, change: 2.8, pe: 25.6, pb: 7.5, roe: 29.3, industry: 'consumer' },
            { code: '601012', name: 'éš†åŸºç»¿èƒ½', price: 25.80, change: -3.5, pe: 15.8, pb: 2.8, roe: 17.8, industry: 'energy' },
            { code: '002594', name: 'æ¯”äºšè¿ª', price: 245.00, change: 5.2, pe: 35.2, pb: 5.8, roe: 16.5, industry: 'tech' },
            { code: '600309', name: 'ä¸‡ååŒ–å­¦', price: 85.60, change: 1.5, pe: 12.8, pb: 3.2, roe: 25.1, industry: 'material' },
            { code: '002304', name: 'æ´‹æ²³è‚¡ä»½', price: 125.80, change: -0.5, pe: 22.3, pb: 5.5, roe: 24.6, industry: 'consumer' },
            { code: '601899', name: 'ç´«é‡‘çŸ¿ä¸š', price: 12.85, change: 2.8, pe: 15.2, pb: 3.8, roe: 25.2, industry: 'material' },
            { code: '600031', name: 'ä¸‰ä¸€é‡å·¥', price: 18.50, change: 1.2, pe: 10.5, pb: 1.8, roe: 17.2, industry: 'industrial' },
            { code: '002475', name: 'ç«‹è®¯ç²¾å¯†', price: 32.50, change: 4.5, pe: 28.5, pb: 5.2, roe: 18.3, industry: 'tech' },
            { code: '600030', name: 'ä¸­ä¿¡è¯åˆ¸', price: 22.80, change: 2.1, pe: 18.5, pb: 1.5, roe: 8.2, industry: 'finance' },
            { code: '000725', name: 'äº¬ä¸œæ–¹A', price: 4.25, change: -1.2, pe: 25.8, pb: 1.2, roe: 4.8, industry: 'tech' },
            { code: '601166', name: 'å…´ä¸šé“¶è¡Œ', price: 16.50, change: 0.8, pe: 5.5, pb: 0.55, roe: 10.1, industry: 'finance' },
            { code: '000063', name: 'ä¸­å…´é€šè®¯', price: 28.90, change: 3.8, pe: 22.5, pb: 2.8, roe: 12.5, industry: 'tech' },
            { code: '002352', name: 'é¡ºä¸°æ§è‚¡', price: 42.50, change: 1.5, pe: 32.5, pb: 3.5, roe: 10.8, industry: 'industrial' }
        ];

        let stocks = [];
        let filteredStocks = [];
        let favorites = JSON.parse(localStorage.getItem('favorites')) || [];
        let portfolio = JSON.parse(localStorage.getItem('portfolio')) || [];
        let historicalData = {};
        let sortConfig = { key: 'code', order: 'asc' };
        let isRealTimeData = false;
        let refreshTimer = null;

        // ==================== åˆå§‹åŒ– ====================
        document.addEventListener('DOMContentLoaded', () => {
            loadRealTimeData();
            attachEventListeners();
            // æ¯60ç§’è‡ªåŠ¨åˆ·æ–°
            refreshTimer = setInterval(loadRealTimeData, 60000);
        });

        // ==================== å®æ—¶æ•°æ®åŠ è½½ ====================
        const API_URL = 'https://stock-api-taupe.vercel.app/api/stocks';
        const SEARCH_API = 'https://stock-api-taupe.vercel.app/api/search';
        
        // è‚¡ç¥¨åç§°æ˜ å°„ï¼ˆè§£å†³APIè¿”å›ä¹±ç é—®é¢˜ï¼‰
        const STOCK_NAMES = {
            '600519':'è´µå·èŒ…å°','000858':'äº”ç²®æ¶²','300750':'å®å¾·æ—¶ä»£','002594':'æ¯”äºšè¿ª',
            '000333':'ç¾çš„é›†å›¢','000651':'æ ¼åŠ›ç”µå™¨','600036':'æ‹›å•†é“¶è¡Œ','601318':'ä¸­å›½å¹³å®‰',
            '000725':'äº¬ä¸œæ–¹A','002415':'æµ·åº·å¨è§†','600000':'æµ¦å‘é“¶è¡Œ','601398':'å·¥å•†é“¶è¡Œ',
            '601988':'ä¸­å›½é“¶è¡Œ','600030':'ä¸­ä¿¡è¯åˆ¸','000001':'å¹³å®‰é“¶è¡Œ','600276':'æ’ç‘åŒ»è¯',
            '600887':'ä¼Šåˆ©è‚¡ä»½','000568':'æ³¸å·è€çª–','002304':'æ´‹æ²³è‚¡ä»½','600900':'é•¿æ±Ÿç”µåŠ›',
            '601012':'éš†åŸºç»¿èƒ½','600309':'ä¸‡ååŒ–å­¦','601899':'ç´«é‡‘çŸ¿ä¸š','600031':'ä¸‰ä¸€é‡å·¥',
            '002475':'ç«‹è®¯ç²¾å¯†','601166':'å…´ä¸šé“¶è¡Œ','000063':'ä¸­å…´é€šè®¯','002352':'é¡ºä¸°æ§è‚¡',
            '603288':'æµ·å¤©å‘³ä¸š','600809':'å±±è¥¿æ±¾é…’','300059':'ä¸œæ–¹è´¢å¯Œ','002230':'ç§‘å¤§è®¯é£',
            '000538':'äº‘å—ç™½è¯','600196':'å¤æ˜ŸåŒ»è¯','601668':'ä¸­å›½å»ºç­‘','601390':'ä¸­å›½ä¸­é“',
            '600048':'ä¿åˆ©å‘å±•','600011':'åèƒ½å›½é™…','601985':'ä¸­å›½æ ¸ç”µ','600585':'æµ·èºæ°´æ³¥',
            '000423':'ä¸œé˜¿é˜¿èƒ¶','002460':'èµ£é”‹é”‚ä¸š','600219':'å—å±±é“ä¸š','601100':'æ’ç«‹æ¶²å‹',
            '000630':'é“œé™µæœ‰è‰²','002466':'å¤©é½é”‚ä¸š','600426':'åé²æ’å‡','601688':'åæ³°è¯åˆ¸',
            '601601':'ä¸­å›½å¤ªä¿','601328':'äº¤é€šé“¶è¡Œ','000002':'ä¸‡ç§‘A'
        };
        
        async function loadRealTimeData() {
            showMsg('overviewMsg', 'ğŸ”„ æ­£åœ¨è·å–æ•°æ®...', 'info');
            
            try {
                const response = await fetch(API_URL);
                const result = await response.json();
                if (result.success && result.data && result.data.length > 0) {
                    stocks = result.data.map(s => ({
                        ...s,
                        name: STOCK_NAMES[s.code] || s.name || s.code,
                        fullCode: s.fullCode || ((s.code.startsWith('6') ? 'sh' : 'sz') + s.code),
                        industry: getIndustryByCode(s.code)
                    }));
                    isRealTimeData = true;
                    showMsg('overviewMsg', 'âœ… å®æ—¶æ•°æ® | å…± ' + stocks.length + ' åªè‚¡ç¥¨ | ' + new Date().toLocaleTimeString(), 'success');
                    updateUI();
                    return;
                }
            } catch (error) {
                console.log('APIè¯·æ±‚å¤±è´¥:', error);
            }
            
            // APIå¤±è´¥æ—¶ä½¿ç”¨æœ¬åœ°æ•°æ®
            loadLocalData();
            showMsg('overviewMsg', 'âš ï¸ ä½¿ç”¨æœ¬åœ°æ•°æ® | å…± ' + stocks.length + ' åªè‚¡ç¥¨', 'error');
            updateUI();
        }
        
        function getIndustryByCode(code) {
            const ind = {
                '600036':'finance','601318':'finance','600000':'finance','601398':'finance','601988':'finance',
                '601166':'finance','000001':'finance','600030':'finance','601688':'finance','601601':'finance','601328':'finance',
                '600519':'consumer','000858':'consumer','000333':'consumer','000651':'consumer','600887':'consumer',
                '000568':'consumer','002304':'consumer','603288':'consumer','600809':'consumer',
                '300750':'tech','002594':'tech','002415':'tech','000725':'tech','300059':'tech','002230':'tech','002475':'tech','000063':'tech',
                '600276':'healthcare','000538':'healthcare','600196':'healthcare',
                '600900':'energy','601012':'energy','600011':'energy','601985':'energy',
                '600309':'material','601899':'material','600585':'material','000423':'material','002460':'material','002466':'material','000630':'material','600219':'material','600426':'material',
                '600031':'industrial','601668':'industrial','601390':'industrial','600048':'industrial','002352':'industrial','601100':'industrial','000002':'industrial'
            };
            return ind[code] || 'other';
        }

        // æœç´¢ä»»æ„è‚¡ç¥¨
        async function searchStock() {
            const code = document.getElementById('searchCode').value.trim();
            if (!code) {
                alert('è¯·è¾“å…¥è‚¡ç¥¨ä»£ç ');
                return;
            }
            
            showMsg('overviewMsg', 'ğŸ” æ­£åœ¨æœç´¢ ' + code + '...', 'info');
            
            try {
                const response = await fetch(SEARCH_API + '?code=' + code);
                const result = await response.json();
                
                if (result.success && result.data) {
                    const s = result.data;
                    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
                    const exists = stocks.find(stock => stock.code === code);
                    if (!exists) {
                        stocks.unshift({
                            code: code,
                            name: code,
                            price: s.price,
                            change: s.change,
                            pe: s.pe,
                            pb: s.pb,
                            roe: 0,
                            high: s.high,
                            low: s.low,
                            open: s.open,
                            volume: s.volume,
                            turnover: s.turnover,
                            industry: 'other',
                            fullCode: (code.startsWith('6') ? 'sh' : 'sz') + code
                        });
                    } else {
                        // æ›´æ–°å·²å­˜åœ¨çš„æ•°æ®
                        Object.assign(exists, {
                            price: s.price,
                            change: s.change,
                            pe: s.pe,
                            pb: s.pb,
                            high: s.high,
                            low: s.low
                        });
                    }
                    showMsg('overviewMsg', 'âœ… æ‰¾åˆ°è‚¡ç¥¨ ' + code + ' | ç°ä»·: Â¥' + s.price + ' | æ¶¨è·Œ: ' + s.change + '%', 'success');
                    updateUI();
                    document.getElementById('searchCode').value = '';
                } else {
                    showMsg('overviewMsg', 'âŒ æœªæ‰¾åˆ°è‚¡ç¥¨ ' + code + 'ï¼Œè¯·æ£€æŸ¥ä»£ç æ˜¯å¦æ­£ç¡®', 'error');
                }
            } catch (error) {
                showMsg('overviewMsg', 'âŒ æœç´¢å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // æ›´æ–°UI
        function updateUI() {
            filteredStocks = [...stocks];
            renderStocks();
            updateStats();
            updateFavorites();
            updatePortfolio();
            drawIndustryChart();
        }

        // åŠ è½½æœ¬åœ°æ•°æ®
        function loadLocalData() {
            stocks = stockDatabase.map(s => ({
                ...s,
                fullCode: (s.code.startsWith('6') ? 'sh' : 'sz') + s.code
            }));
        }

        function attachEventListeners() {
            document.getElementById('filterBtn').addEventListener('click', applyFilters);
            document.getElementById('resetBtn').addEventListener('click', resetFilters);
            document.getElementById('refreshBtn').addEventListener('click', refreshData);
        }

        // ==================== ç­›é€‰åŠŸèƒ½ ====================
        function applyFilters() {
            const code = document.getElementById('codeFilter').value.toLowerCase();
            const priceMin = parseFloat(document.getElementById('priceMin').value) || 0;
            const priceMax = parseFloat(document.getElementById('priceMax').value) || Infinity;
            const changeMin = parseFloat(document.getElementById('changeMin').value) || -Infinity;
            const changeMax = parseFloat(document.getElementById('changeMax').value) || Infinity;
            const peMin = parseFloat(document.getElementById('peMin').value) || 0;
            const peMax = parseFloat(document.getElementById('peMax').value) || Infinity;
            const pbMin = parseFloat(document.getElementById('pbMin').value) || 0;
            const pbMax = parseFloat(document.getElementById('pbMax').value) || Infinity;
            const roeMin = parseFloat(document.getElementById('roeMin').value) || -Infinity;
            const roeMax = parseFloat(document.getElementById('roeMax').value) || Infinity;
            const industry = document.getElementById('industryFilter').value;

            filteredStocks = stocks.filter(s => {
                return (s.code.includes(code) || s.name.toLowerCase().includes(code)) &&
                    s.price >= priceMin && s.price <= priceMax &&
                    s.change >= changeMin && s.change <= changeMax &&
                    s.pe >= peMin && s.pe <= peMax &&
                    s.pb >= pbMin && s.pb <= pbMax &&
                    s.roe >= roeMin && s.roe <= roeMax &&
                    (!industry || s.industry === industry);
            });

            renderStocks();
            updateStats();
        }

        function resetFilters() {
            ['codeFilter', 'priceMin', 'priceMax', 'changeMin', 'changeMax', 'peMin', 'peMax', 'pbMin', 'pbMax', 'roeMin', 'roeMax'].forEach(id => document.getElementById(id).value = '');
            document.getElementById('industryFilter').value = '';
            filteredStocks = [...stocks];
            renderStocks();
            updateStats();
        }

        function refreshData() {
            loadRealTimeData();
        }

        // ==================== æ¸²æŸ“è‚¡ç¥¨è¡¨æ ¼ ====================
        function renderStocks() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            document.getElementById('stockCount').textContent = `(å…± ${filteredStocks.length} åª)`;

            filteredStocks.forEach(s => {
                const changeClass = s.change > 0 ? 'up' : s.change < 0 ? 'down' : '';
                const changeSign = s.change > 0 ? '+' : '';
                const isFav = favorites.includes(s.code);
                tbody.innerHTML += `
                    <tr>
                        <td class="code">${s.code}</td>
                        <td>${s.name}</td>
                        <td>Â¥${s.price.toFixed(2)}</td>
                        <td class="change ${changeClass}">${changeSign}${s.change.toFixed(2)}%</td>
                        <td>${s.pe.toFixed(1)}</td>
                        <td>${s.pb.toFixed(2)}</td>
                        <td>${s.roe.toFixed(1)}%</td>
                        <td>${industryMap[s.industry]}</td>
                        <td>
                            <button class="btn-small" onclick="toggleFavorite('${s.code}')" style="background:${isFav ? '#f39c12' : '#667eea'}">${isFav ? 'â­' : 'â˜†'}</button>
                            <button class="btn-small" onclick="showTechnical('${s.code}')">ğŸ“‰</button>
                            <button class="btn-small" onclick="showFlow('${s.code}')">ğŸ’°</button>
                        </td>
                    </tr>
                `;
            });
        }

        // ==================== ç»Ÿè®¡ä¿¡æ¯ ====================
        function updateStats() {
            const data = filteredStocks;
            if (data.length === 0) {
                ['statTotal', 'statAvgPrice', 'statAvgChange', 'statUp', 'statDown', 'statAvgPe'].forEach(id => document.getElementById(id).textContent = '0');
                return;
            }
            document.getElementById('statTotal').textContent = data.length;
            document.getElementById('statAvgPrice').textContent = 'Â¥' + (data.reduce((sum, s) => sum + s.price, 0) / data.length).toFixed(2);
            const avgChange = data.reduce((sum, s) => sum + s.change, 0) / data.length;
            document.getElementById('statAvgChange').textContent = (avgChange >= 0 ? '+' : '') + avgChange.toFixed(2) + '%';
            document.getElementById('statUp').textContent = data.filter(s => s.change > 0).length;
            document.getElementById('statDown').textContent = data.filter(s => s.change < 0).length;
            document.getElementById('statAvgPe').textContent = (data.reduce((sum, s) => sum + s.pe, 0) / data.length).toFixed(1);
        }

        // ==================== è¡Œä¸šåˆ†å¸ƒå›¾ ====================
        function drawIndustryChart() {
            const industryStats = {};
            stocks.forEach(s => { industryStats[s.industry] = (industryStats[s.industry] || 0) + 1; });
            
            const chart = echarts.init(document.getElementById('industryChart'));
            chart.setOption({
                title: { text: 'è¡Œä¸šåˆ†å¸ƒ', left: 'center' },
                tooltip: { trigger: 'item' },
                series: [{
                    type: 'pie',
                    radius: ['40%', '70%'],
                    data: Object.entries(industryStats).map(([k, v]) => ({ name: industryMap[k], value: v })),
                    emphasis: { itemStyle: { shadowBlur: 10, shadowOffsetX: 0, shadowColor: 'rgba(0, 0, 0, 0.5)' } }
                }]
            });
            window.addEventListener('resize', () => chart.resize());
        }

        // ==================== æŠ€æœ¯åˆ†æ ====================
        function showTechnical(code) {
            document.getElementById('techCode').value = code;
            switchTab('technical');
            loadTechnicalAnalysis();
        }

        function loadTechnicalAnalysis() {
            const code = document.getElementById('techCode').value.toUpperCase();
            const stock = stocks.find(s => s.code === code);
            if (!stock) { showMsg('techMsg', 'âŒ è‚¡ç¥¨ä»£ç ä¸å­˜åœ¨', 'error'); return; }
            
            showMsg('techMsg', 'ğŸ“Š æ­£åœ¨ç”ŸæˆæŠ€æœ¯åˆ†æ...', 'info');
            generateHistoricalData(code);
            drawKlineChart(code);
            drawVolumeChart(code);
            drawMAChart(code);
            drawMACDChart(code);
            showMsg('techMsg', 'âœ… ' + stock.name + ' æŠ€æœ¯åˆ†æå®Œæˆ', 'success');
        }

        function generateHistoricalData(code) {
            const stock = stocks.find(s => s.code === code);
            if (!stock) return;
            const data = [];
            let basePrice = stock.price;
            for (let i = 60; i >= 0; i--) {
                const date = new Date(); date.setDate(date.getDate() - i);
                const open = basePrice + (Math.random() - 0.5) * basePrice * 0.03;
                const close = open + (Math.random() - 0.5) * basePrice * 0.03;
                const high = Math.max(open, close) + Math.random() * basePrice * 0.01;
                const low = Math.min(open, close) - Math.random() * basePrice * 0.01;
                const volume = Math.floor(Math.random() * 100000000 + 50000000);
                data.push({ date: date.toISOString().split('T')[0], open: +open.toFixed(2), close: +close.toFixed(2), high: +high.toFixed(2), low: +low.toFixed(2), volume });
                basePrice = close;
            }
            historicalData[code] = data;
        }

        function drawKlineChart(code) {
            const data = historicalData[code] || [];
            const stock = stocks.find(s => s.code === code);
            const chart = echarts.init(document.getElementById('klineChart'));
            chart.setOption({
                title: { text: stock.name + ' Kçº¿å›¾', left: 'center' },
                tooltip: { trigger: 'axis', axisPointer: { type: 'cross' } },
                xAxis: { type: 'category', data: data.map(d => d.date), boundaryGap: true },
                yAxis: { type: 'value', scale: true },
                dataZoom: [{ type: 'inside', start: 50, end: 100 }],
                series: [{ type: 'candlestick', data: data.map(d => [d.open, d.close, d.low, d.high]), itemStyle: { color: '#f56c6c', color0: '#67c23a', borderColor: '#f56c6c', borderColor0: '#67c23a' } }]
            });
            window.addEventListener('resize', () => chart.resize());
        }

        function drawVolumeChart(code) {
            const data = historicalData[code] || [];
            const stock = stocks.find(s => s.code === code);
            const chart = echarts.init(document.getElementById('volumeChart'));
            chart.setOption({
                title: { text: stock.name + ' æˆäº¤é‡', left: 'center' },
                tooltip: { trigger: 'axis' },
                xAxis: { type: 'category', data: data.map(d => d.date) },
                yAxis: { type: 'value', axisLabel: { formatter: v => (v / 100000000).toFixed(1) + 'äº¿' } },
                dataZoom: [{ type: 'inside', start: 50, end: 100 }],
                series: [{ type: 'bar', data: data.map((d, i) => ({ value: d.volume, itemStyle: { color: d.close >= d.open ? '#f56c6c' : '#67c23a' } })) }]
            });
            window.addEventListener('resize', () => chart.resize());
        }

        function drawMAChart(code) {
            const data = historicalData[code] || [];
            const closes = data.map(d => d.close);
            const chart = echarts.init(document.getElementById('maChart'));
            chart.setOption({
                title: { text: 'å‡çº¿åˆ†æ', left: 'center' },
                tooltip: { trigger: 'axis' },
                legend: { data: ['æ”¶ç›˜ä»·', 'MA5', 'MA10', 'MA20', 'MA60'], top: 30 },
                xAxis: { type: 'category', data: data.map(d => d.date) },
                yAxis: { type: 'value', scale: true },
                dataZoom: [{ type: 'inside', start: 50, end: 100 }],
                series: [
                    { name: 'æ”¶ç›˜ä»·', type: 'line', data: closes, lineStyle: { color: '#333' } },
                    { name: 'MA5', type: 'line', data: calcMA(closes, 5), lineStyle: { color: '#f39c12' } },
                    { name: 'MA10', type: 'line', data: calcMA(closes, 10), lineStyle: { color: '#e74c3c' } },
                    { name: 'MA20', type: 'line', data: calcMA(closes, 20), lineStyle: { color: '#27ae60' } },
                    { name: 'MA60', type: 'line', data: calcMA(closes, 60), lineStyle: { color: '#9b59b6' } }
                ]
            });
            window.addEventListener('resize', () => chart.resize());
        }

        function drawMACDChart(code) {
            const data = historicalData[code] || [];
            const closes = data.map(d => d.close);
            const macd = calcMACD(closes);
            const chart = echarts.init(document.getElementById('macdChart'));
            chart.setOption({
                title: { text: 'MACDæŒ‡æ ‡', left: 'center' },
                tooltip: { trigger: 'axis' },
                legend: { data: ['DIF', 'DEA', 'MACD'], top: 30 },
                xAxis: { type: 'category', data: data.map(d => d.date) },
                yAxis: { type: 'value' },
                dataZoom: [{ type: 'inside', start: 50, end: 100 }],
                series: [
                    { name: 'DIF', type: 'line', data: macd.dif, lineStyle: { color: '#3498db' } },
                    { name: 'DEA', type: 'line', data: macd.dea, lineStyle: { color: '#e74c3c' } },
                    { name: 'MACD', type: 'bar', data: macd.macd.map(v => ({ value: v, itemStyle: { color: v >= 0 ? '#f56c6c' : '#67c23a' } })) }
                ]
            });
            window.addEventListener('resize', () => chart.resize());
        }

        // ==================== æŠ€æœ¯æŒ‡æ ‡ ====================
        function loadIndicators() {
            const code = document.getElementById('indicatorCode').value.toUpperCase();
            const stock = stocks.find(s => s.code === code);
            if (!stock) { showMsg('indicatorMsg', 'âŒ è‚¡ç¥¨ä»£ç ä¸å­˜åœ¨', 'error'); return; }
            
            if (!historicalData[code]) generateHistoricalData(code);
            const data = historicalData[code];
            const closes = data.map(d => d.close);
            const highs = data.map(d => d.high);
            const lows = data.map(d => d.low);
            
            // è®¡ç®—å„ç§æŒ‡æ ‡
            const rsi = calcRSI(closes, 14);
            const kdj = calcKDJ(highs, lows, closes);
            const macd = calcMACD(closes);
            const bollinger = calcBollinger(closes, 20);
            
            // æ˜¾ç¤ºæŒ‡æ ‡é¢æ¿
            const lastRsi = rsi[rsi.length - 1];
            const lastK = kdj.k[kdj.k.length - 1];
            const lastD = kdj.d[kdj.d.length - 1];
            const lastJ = kdj.j[kdj.j.length - 1];
            const lastDif = macd.dif[macd.dif.length - 1];
            const lastDea = macd.dea[macd.dea.length - 1];
            
            document.getElementById('indicatorGrid').innerHTML = `
                <div class="indicator-item"><div class="indicator-label">RSI(14)</div><div class="indicator-value ${lastRsi > 70 ? 'bullish' : lastRsi < 30 ? 'bearish' : 'neutral'}">${lastRsi?.toFixed(2) || '-'}</div></div>
                <div class="indicator-item"><div class="indicator-label">KDJ-K</div><div class="indicator-value ${lastK > 80 ? 'bullish' : lastK < 20 ? 'bearish' : 'neutral'}">${lastK?.toFixed(2) || '-'}</div></div>
                <div class="indicator-item"><div class="indicator-label">KDJ-D</div><div class="indicator-value ${lastD > 80 ? 'bullish' : lastD < 20 ? 'bearish' : 'neutral'}">${lastD?.toFixed(2) || '-'}</div></div>
                <div class="indicator-item"><div class="indicator-label">KDJ-J</div><div class="indicator-value ${lastJ > 100 ? 'bullish' : lastJ < 0 ? 'bearish' : 'neutral'}">${lastJ?.toFixed(2) || '-'}</div></div>
                <div class="indicator-item"><div class="indicator-label">MACD-DIF</div><div class="indicator-value ${lastDif > 0 ? 'bullish' : 'bearish'}">${lastDif?.toFixed(3) || '-'}</div></div>
                <div class="indicator-item"><div class="indicator-label">MACD-DEA</div><div class="indicator-value ${lastDea > 0 ? 'bullish' : 'bearish'}">${lastDea?.toFixed(3) || '-'}</div></div>
                <div class="indicator-item"><div class="indicator-label">MA5</div><div class="indicator-value">${calcMA(closes, 5).slice(-1)[0]?.toFixed(2) || '-'}</div></div>
                <div class="indicator-item"><div class="indicator-label">MA20</div><div class="indicator-value">${calcMA(closes, 20).slice(-1)[0]?.toFixed(2) || '-'}</div></div>
            `;
            
            drawRSIChart(code, rsi, data);
            drawKDJChart(code, kdj, data);
            drawBollingerChart(code, bollinger, closes, data);
            showMsg('indicatorMsg', 'âœ… ' + stock.name + ' æŠ€æœ¯æŒ‡æ ‡è®¡ç®—å®Œæˆ', 'success');
        }

        function drawRSIChart(code, rsi, data) {
            const chart = echarts.init(document.getElementById('rsiChart'));
            chart.setOption({
                title: { text: 'RSIæŒ‡æ ‡', left: 'center' },
                tooltip: { trigger: 'axis' },
                xAxis: { type: 'category', data: data.map(d => d.date) },
                yAxis: { type: 'value', min: 0, max: 100 },
                dataZoom: [{ type: 'inside', start: 50, end: 100 }],
                series: [
                    { name: 'RSI', type: 'line', data: rsi, lineStyle: { color: '#9b59b6' } },
                    { name: 'è¶…ä¹°çº¿', type: 'line', data: data.map(() => 70), lineStyle: { color: '#f56c6c', type: 'dashed' } },
                    { name: 'è¶…å–çº¿', type: 'line', data: data.map(() => 30), lineStyle: { color: '#67c23a', type: 'dashed' } }
                ]
            });
            window.addEventListener('resize', () => chart.resize());
        }

        function drawKDJChart(code, kdj, data) {
            const chart = echarts.init(document.getElementById('kdjChart'));
            chart.setOption({
                title: { text: 'KDJæŒ‡æ ‡', left: 'center' },
                tooltip: { trigger: 'axis' },
                legend: { data: ['K', 'D', 'J'], top: 30 },
                xAxis: { type: 'category', data: data.map(d => d.date) },
                yAxis: { type: 'value' },
                dataZoom: [{ type: 'inside', start: 50, end: 100 }],
                series: [
                    { name: 'K', type: 'line', data: kdj.k, lineStyle: { color: '#3498db' } },
                    { name: 'D', type: 'line', data: kdj.d, lineStyle: { color: '#e74c3c' } },
                    { name: 'J', type: 'line', data: kdj.j, lineStyle: { color: '#9b59b6' } }
                ]
            });
            window.addEventListener('resize', () => chart.resize());
        }

        function drawBollingerChart(code, bollinger, closes, data) {
            const stock = stocks.find(s => s.code === code);
            const chart = echarts.init(document.getElementById('bollingerChart'));
            chart.setOption({
                title: { text: stock.name + ' å¸ƒæ—å¸¦', left: 'center' },
                tooltip: { trigger: 'axis' },
                legend: { data: ['æ”¶ç›˜ä»·', 'ä¸Šè½¨', 'ä¸­è½¨', 'ä¸‹è½¨'], top: 30 },
                xAxis: { type: 'category', data: data.map(d => d.date) },
                yAxis: { type: 'value', scale: true },
                dataZoom: [{ type: 'inside', start: 50, end: 100 }],
                series: [
                    { name: 'æ”¶ç›˜ä»·', type: 'line', data: closes, lineStyle: { color: '#333' } },
                    { name: 'ä¸Šè½¨', type: 'line', data: bollinger.upper, lineStyle: { color: '#f56c6c' } },
                    { name: 'ä¸­è½¨', type: 'line', data: bollinger.middle, lineStyle: { color: '#3498db' } },
                    { name: 'ä¸‹è½¨', type: 'line', data: bollinger.lower, lineStyle: { color: '#67c23a' } }
                ]
            });
            window.addEventListener('resize', () => chart.resize());
        }

        // ==================== èµ„é‡‘æµå‘ ====================
        function showFlow(code) {
            document.getElementById('flowCode').value = code;
            switchTab('flow');
            loadFlowAnalysis();
        }

        function loadFlowAnalysis() {
            const code = document.getElementById('flowCode').value.toUpperCase();
            const stock = stocks.find(s => s.code === code);
            if (!stock) { showMsg('flowMsg', 'âŒ è‚¡ç¥¨ä»£ç ä¸å­˜åœ¨', 'error'); return; }
            
            // æ¨¡æ‹Ÿèµ„é‡‘æµå‘æ•°æ®
            const mainFlow = (Math.random() - 0.5) * 200000000;
            const bigFlow = (Math.random() - 0.5) * 150000000;
            const midFlow = (Math.random() - 0.5) * 100000000;
            const smallFlow = (Math.random() - 0.5) * 80000000;
            
            document.getElementById('mainFlow').textContent = formatMoney(mainFlow);
            document.getElementById('bigFlow').textContent = formatMoney(bigFlow);
            document.getElementById('midFlow').textContent = formatMoney(midFlow);
            document.getElementById('smallFlow').textContent = formatMoney(smallFlow);
            
            drawFlowPieChart(mainFlow, bigFlow, midFlow, smallFlow);
            drawFlowBarChart(code);
            drawFlowTrendChart(code);
            showMsg('flowMsg', 'âœ… ' + stock.name + ' èµ„é‡‘æµå‘åˆ†æå®Œæˆ', 'success');
        }

        function drawFlowPieChart(main, big, mid, small) {
            const chart = echarts.init(document.getElementById('flowPieChart'));
            chart.setOption({
                title: { text: 'èµ„é‡‘åˆ†å¸ƒ', left: 'center' },
                tooltip: { trigger: 'item', formatter: '{b}: {c}äº¿ ({d}%)' },
                series: [{
                    type: 'pie',
                    radius: ['40%', '70%'],
                    data: [
                        { name: 'ä¸»åŠ›èµ„é‡‘', value: Math.abs(main / 100000000).toFixed(2), itemStyle: { color: '#f56c6c' } },
                        { name: 'å¤§å•èµ„é‡‘', value: Math.abs(big / 100000000).toFixed(2), itemStyle: { color: '#e6a23c' } },
                        { name: 'ä¸­å•èµ„é‡‘', value: Math.abs(mid / 100000000).toFixed(2), itemStyle: { color: '#409eff' } },
                        { name: 'å°å•èµ„é‡‘', value: Math.abs(small / 100000000).toFixed(2), itemStyle: { color: '#67c23a' } }
                    ]
                }]
            });
            window.addEventListener('resize', () => chart.resize());
        }

        function drawFlowBarChart(code) {
            const stock = stocks.find(s => s.code === code);
            const chart = echarts.init(document.getElementById('flowBarChart'));
            const days = ['5æ—¥', '10æ—¥', '20æ—¥', '30æ—¥'];
            chart.setOption({
                title: { text: stock.name + ' èµ„é‡‘æµå…¥è¶‹åŠ¿', left: 'center' },
                tooltip: { trigger: 'axis' },
                xAxis: { type: 'category', data: days },
                yAxis: { type: 'value', axisLabel: { formatter: v => v + 'äº¿' } },
                series: [
                    { name: 'ä¸»åŠ›', type: 'bar', data: days.map(() => ((Math.random() - 0.5) * 5).toFixed(2)), itemStyle: { color: '#f56c6c' } },
                    { name: 'æ•£æˆ·', type: 'bar', data: days.map(() => ((Math.random() - 0.5) * 3).toFixed(2)), itemStyle: { color: '#67c23a' } }
                ]
            });
            window.addEventListener('resize', () => chart.resize());
        }

        function drawFlowTrendChart(code) {
            const stock = stocks.find(s => s.code === code);
            const dates = [];
            const mainData = [], retailData = [];
            for (let i = 30; i >= 0; i--) {
                const d = new Date(); d.setDate(d.getDate() - i);
                dates.push(d.toISOString().split('T')[0]);
                mainData.push(((Math.random() - 0.5) * 2).toFixed(2));
                retailData.push(((Math.random() - 0.5) * 1.5).toFixed(2));
            }
            const chart = echarts.init(document.getElementById('flowTrendChart'));
            chart.setOption({
                title: { text: stock.name + ' 30æ—¥èµ„é‡‘æµå‘', left: 'center' },
                tooltip: { trigger: 'axis' },
                legend: { data: ['ä¸»åŠ›å‡€æµå…¥', 'æ•£æˆ·å‡€æµå…¥'], top: 30 },
                xAxis: { type: 'category', data: dates },
                yAxis: { type: 'value', axisLabel: { formatter: v => v + 'äº¿' } },
                dataZoom: [{ type: 'inside', start: 0, end: 100 }],
                series: [
                    { name: 'ä¸»åŠ›å‡€æµå…¥', type: 'line', data: mainData, areaStyle: { opacity: 0.3 }, lineStyle: { color: '#f56c6c' }, itemStyle: { color: '#f56c6c' } },
                    { name: 'æ•£æˆ·å‡€æµå…¥', type: 'line', data: retailData, areaStyle: { opacity: 0.3 }, lineStyle: { color: '#67c23a' }, itemStyle: { color: '#67c23a' } }
                ]
            });
            window.addEventListener('resize', () => chart.resize());
        }

        // ==================== å¯¹æ¯”åˆ†æ ====================
        function compareStocks() {
            const code1 = document.getElementById('compareCode1').value.toUpperCase();
            const code2 = document.getElementById('compareCode2').value.toUpperCase();
            const s1 = stocks.find(s => s.code === code1);
            const s2 = stocks.find(s => s.code === code2);
            
            if (!s1 || !s2) { showMsg('compareMsg', 'âŒ è‚¡ç¥¨ä»£ç ä¸å­˜åœ¨', 'error'); return; }
            
            document.getElementById('comparisonResult').innerHTML = `
                <div class="comparison-card">
                    <h4>${s1.name} (${s1.code})</h4>
                    <div class="comparison-item"><span>ç°ä»·</span><span>Â¥${s1.price.toFixed(2)}</span></div>
                    <div class="comparison-item"><span>æ¶¨è·Œå¹…</span><span class="change ${s1.change > 0 ? 'up' : 'down'}">${s1.change > 0 ? '+' : ''}${s1.change.toFixed(2)}%</span></div>
                    <div class="comparison-item"><span>å¸‚ç›ˆç‡</span><span>${s1.pe.toFixed(2)}</span></div>
                    <div class="comparison-item"><span>å¸‚å‡€ç‡</span><span>${s1.pb.toFixed(2)}</span></div>
                    <div class="comparison-item"><span>ROE</span><span>${s1.roe.toFixed(2)}%</span></div>
                    <div class="comparison-item"><span>è¡Œä¸š</span><span>${industryMap[s1.industry]}</span></div>
                </div>
                <div class="comparison-card">
                    <h4>${s2.name} (${s2.code})</h4>
                    <div class="comparison-item"><span>ç°ä»·</span><span>Â¥${s2.price.toFixed(2)}</span></div>
                    <div class="comparison-item"><span>æ¶¨è·Œå¹…</span><span class="change ${s2.change > 0 ? 'up' : 'down'}">${s2.change > 0 ? '+' : ''}${s2.change.toFixed(2)}%</span></div>
                    <div class="comparison-item"><span>å¸‚ç›ˆç‡</span><span>${s2.pe.toFixed(2)}</span></div>
                    <div class="comparison-item"><span>å¸‚å‡€ç‡</span><span>${s2.pb.toFixed(2)}</span></div>
                    <div class="comparison-item"><span>ROE</span><span>${s2.roe.toFixed(2)}%</span></div>
                    <div class="comparison-item"><span>è¡Œä¸š</span><span>${industryMap[s2.industry]}</span></div>
                </div>
            `;
            
            drawCompareChart(s1, s2);
            showMsg('compareMsg', 'âœ… å¯¹æ¯”åˆ†æå®Œæˆ', 'success');
        }

        function drawCompareChart(s1, s2) {
            const chart = echarts.init(document.getElementById('compareChart'));
            chart.setOption({
                title: { text: 'æŒ‡æ ‡å¯¹æ¯”', left: 'center' },
                tooltip: { trigger: 'axis' },
                legend: { data: [s1.name, s2.name], top: 30 },
                radar: {
                    indicator: [
                        { name: 'PE(å€’æ•°Ã—10)', max: 20 },
                        { name: 'PB(å€’æ•°Ã—10)', max: 20 },
                        { name: 'ROE', max: 50 },
                        { name: 'æ¶¨è·Œå¹…+10', max: 20 }
                    ]
                },
                series: [{
                    type: 'radar',
                    data: [
                        { name: s1.name, value: [100/s1.pe, 10/s1.pb, s1.roe, s1.change + 10], areaStyle: { opacity: 0.3 } },
                        { name: s2.name, value: [100/s2.pe, 10/s2.pb, s2.roe, s2.change + 10], areaStyle: { opacity: 0.3 } }
                    ]
                }]
            });
            window.addEventListener('resize', () => chart.resize());
        }

        // ==================== æ”¶è—ç®¡ç† ====================
        function toggleFavorite(code) {
            const idx = favorites.indexOf(code);
            if (idx > -1) favorites.splice(idx, 1);
            else favorites.push(code);
            localStorage.setItem('favorites', JSON.stringify(favorites));
            renderStocks();
            updateFavorites();
        }

        function updateFavorites() {
            const tbody = document.getElementById('favoritesBody');
            tbody.innerHTML = favorites.length === 0 ? '<tr><td colspan="7" style="text-align:center;color:#999;">æš‚æ— æ”¶è—</td></tr>' : '';
            favorites.forEach(code => {
                const s = stocks.find(st => st.code === code);
                if (s) {
                    const changeClass = s.change > 0 ? 'up' : s.change < 0 ? 'down' : '';
                    tbody.innerHTML += `<tr><td class="code">${s.code}</td><td>${s.name}</td><td>Â¥${s.price.toFixed(2)}</td><td class="change ${changeClass}">${s.change > 0 ? '+' : ''}${s.change.toFixed(2)}%</td><td>${s.pe.toFixed(1)}</td><td>${industryMap[s.industry]}</td><td><button class="btn-small" onclick="toggleFavorite('${s.code}')">ç§»é™¤</button></td></tr>`;
                }
            });
        }

        // ==================== æŠ•èµ„ç»„åˆ ====================
        function addPortfolio() {
            const code = document.getElementById('portfolioCode').value.toUpperCase();
            const qty = parseFloat(document.getElementById('portfolioQty').value);
            const cost = parseFloat(document.getElementById('portfolioCost').value);
            if (!code || !qty || !cost) { alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯'); return; }
            const stock = stocks.find(s => s.code === code);
            if (!stock) { alert('è‚¡ç¥¨ä»£ç ä¸å­˜åœ¨'); return; }
            portfolio.push({ code, name: stock.name, qty, cost, price: stock.price });
            localStorage.setItem('portfolio', JSON.stringify(portfolio));
            ['portfolioCode', 'portfolioQty', 'portfolioCost'].forEach(id => document.getElementById(id).value = '');
            updatePortfolio();
        }

        function updatePortfolio() {
            const tbody = document.getElementById('portfolioBody');
            tbody.innerHTML = portfolio.length === 0 ? '<tr><td colspan="8" style="text-align:center;color:#999;">æš‚æ— æŒä»“</td></tr>' : '';
            let totalMV = 0, totalCost = 0;
            portfolio.forEach((item, idx) => {
                const stock = stocks.find(s => s.code === item.code);
                const price = stock ? stock.price : item.price;
                const mv = item.qty * price;
                const profit = mv - item.qty * item.cost;
                const rate = ((price - item.cost) / item.cost * 100).toFixed(2);
                totalMV += mv; totalCost += item.qty * item.cost;
                tbody.innerHTML += `<tr><td class="code">${item.code}</td><td>${item.name}</td><td>${item.qty}</td><td>Â¥${item.cost.toFixed(2)}</td><td>Â¥${price.toFixed(2)}</td><td style="color:${profit >= 0 ? '#f56c6c' : '#67c23a'}">Â¥${profit.toFixed(2)}</td><td style="color:${profit >= 0 ? '#f56c6c' : '#67c23a'}">${rate}%</td><td><button class="btn-small" onclick="removePortfolio(${idx})">åˆ é™¤</button></td></tr>`;
            });
            const totalProfit = totalMV - totalCost;
            const totalRate = totalCost > 0 ? ((totalProfit / totalCost) * 100).toFixed(2) : '0';
            document.getElementById('portfolioTotal').textContent = 'Â¥' + totalMV.toFixed(2);
            document.getElementById('portfolioCostTotal').textContent = 'Â¥' + totalCost.toFixed(2);
            document.getElementById('portfolioProfit').textContent = 'Â¥' + totalProfit.toFixed(2);
            document.getElementById('portfolioRate').textContent = totalRate + '%';
        }

        function removePortfolio(idx) {
            portfolio.splice(idx, 1);
            localStorage.setItem('portfolio', JSON.stringify(portfolio));
            updatePortfolio();
        }

        // ==================== å·¥å…·å‡½æ•° ====================
        function switchTab(name) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('tab-' + name).classList.add('active');
            event.target.classList.add('active');
        }

        function sortTable(key) {
            sortConfig.order = sortConfig.key === key && sortConfig.order === 'asc' ? 'desc' : 'asc';
            sortConfig.key = key;
            filteredStocks.sort((a, b) => {
                const result = typeof a[key] === 'string' ? a[key].localeCompare(b[key]) : a[key] - b[key];
                return sortConfig.order === 'asc' ? result : -result;
            });
            renderStocks();
        }

        function exportData() {
            let csv = 'ä»£ç ,åç§°,ç°ä»·,æ¶¨è·Œå¹…,PE,PB,ROE,è¡Œä¸š\n';
            filteredStocks.forEach(s => csv += `${s.code},${s.name},${s.price},${s.change},${s.pe},${s.pb},${s.roe},${industryMap[s.industry]}\n`);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `stocks-${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        function showMsg(id, msg, type) {
            document.getElementById(id).innerHTML = `<div class="message ${type}">${msg}</div>`;
        }

        function formatMoney(v) {
            const abs = Math.abs(v);
            const sign = v >= 0 ? '+' : '-';
            if (abs >= 100000000) return sign + (abs / 100000000).toFixed(2) + 'äº¿';
            if (abs >= 10000) return sign + (abs / 10000).toFixed(2) + 'ä¸‡';
            return sign + abs.toFixed(2);
        }

        // ==================== æŠ€æœ¯æŒ‡æ ‡è®¡ç®— ====================
        function calcMA(data, period) {
            return data.map((_, i) => i < period - 1 ? null : +(data.slice(i - period + 1, i + 1).reduce((a, b) => a + b, 0) / period).toFixed(2));
        }

        function calcEMA(data, period) {
            const k = 2 / (period + 1);
            const ema = [data[0]];
            for (let i = 1; i < data.length; i++) ema.push(data[i] * k + ema[i - 1] * (1 - k));
            return ema;
        }

        function calcMACD(closes) {
            const ema12 = calcEMA(closes, 12);
            const ema26 = calcEMA(closes, 26);
            const dif = ema12.map((v, i) => +(v - ema26[i]).toFixed(4));
            const dea = calcEMA(dif, 9).map(v => +v.toFixed(4));
            const macd = dif.map((v, i) => +((v - dea[i]) * 2).toFixed(4));
            return { dif, dea, macd };
        }

        function calcRSI(closes, period) {
            const rsi = [null];
            for (let i = 1; i < closes.length; i++) {
                if (i < period) { rsi.push(null); continue; }
                let gains = 0, losses = 0;
                for (let j = i - period + 1; j <= i; j++) {
                    const diff = closes[j] - closes[j - 1];
                    if (diff > 0) gains += diff; else losses -= diff;
                }
                const rs = losses === 0 ? 100 : gains / losses;
                rsi.push(+(100 - 100 / (1 + rs)).toFixed(2));
            }
            return rsi;
        }

        function calcKDJ(highs, lows, closes, n = 9) {
            const k = [], d = [], j = [];
            for (let i = 0; i < closes.length; i++) {
                if (i < n - 1) { k.push(null); d.push(null); j.push(null); continue; }
                const highN = Math.max(...highs.slice(i - n + 1, i + 1));
                const lowN = Math.min(...lows.slice(i - n + 1, i + 1));
                const rsv = highN === lowN ? 50 : (closes[i] - lowN) / (highN - lowN) * 100;
                const prevK = k[i - 1] || 50;
                const prevD = d[i - 1] || 50;
                const curK = 2 / 3 * prevK + 1 / 3 * rsv;
                const curD = 2 / 3 * prevD + 1 / 3 * curK;
                k.push(+curK.toFixed(2));
                d.push(+curD.toFixed(2));
                j.push(+(3 * curK - 2 * curD).toFixed(2));
            }
            return { k, d, j };
        }

        function calcBollinger(closes, period = 20, mult = 2) {
            const middle = [], upper = [], lower = [];
            for (let i = 0; i < closes.length; i++) {
                if (i < period - 1) { middle.push(null); upper.push(null); lower.push(null); continue; }
                const slice = closes.slice(i - period + 1, i + 1);
                const ma = slice.reduce((a, b) => a + b, 0) / period;
                const std = Math.sqrt(slice.reduce((sum, v) => sum + Math.pow(v - ma, 2), 0) / period);
                middle.push(+ma.toFixed(2));
                upper.push(+(ma + mult * std).toFixed(2));
                lower.push(+(ma - mult * std).toFixed(2));
            }
            return { middle, upper, lower };
        }
    </script>
</body>
</html>
